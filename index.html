<!DOCTYPE html>
<html>

<head>
	<title>Photo Recoloring Tool by Zhou Bowei</title>
	<link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
	<link type="text/css" rel="stylesheet" href="css/style_user.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

	<header>
		<!-- nav bar -->
		<nav>
			<div class="nav-wrapper">
				<div class="container">
					<a href="https://github.com/b-z/photo_recoloring">
					<span class="brand-logo">PHOTO RECOLORING</span>
				</a>
					<ul id="nav-mobile" class="right hide-on-small-only">
						<li><a href="https://github.com/b-z/photo_recoloring">ZHOU BOWEI</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<!-- nav bar end -->

		<a href="https://github.com/b-z/photo_recoloring" class="hide-on-med-and-down">
			<img style="position: absolute; top: 0; right: 0; border: 0;" src="img/github.png"
			alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png">
		</a>
	</header>
	<main>
		<!-- container -->
		<div class="container">

			<!-- search -->
			<div id="search" class="section">
				<h6 class="row">UPLOAD FILE</h6>

				<div class="row">
					<div class="col s12 m8 l8 offset-m2 offset-l2">
						<form action="#">
							<div class="file-field input-field">
								<div class="btn">
									<input id="file_path" type="file">
									<span><i class="material-icons">perm_media</i></span>
								</div>

								<div class="file-path-wrapper">
									<input class="file-path validate" type="text" placeholder="UPLOAD IMAGE FILE">
								</div>

							</div>
						</form>
					</div>
				</div>

				<h6 class="row source_image_area">THE IMAGE</h6>

				<div class="row source_image_area">
					<div class="col s12 m8 l8 offset-m2 offset-l2">
						<canvas class="materialboxed z-depth-1" id="source_image"></canvas>
					</div>
				</div>

				<div id="palette" class="row source_image_area">

				</div>
			</div>
		</div>
		<!-- container end -->
	</main>

	<!-- footer -->
	<footer class="footer-copyright">
		<div class="container">
			Copyright &copy; 2015 Zhou Bowei. All rights reserved.
		</div>
	</footer>
	<!-- footer end -->
	<script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="js/materialize.min.js"></script>
	<script type="text/javascript" src="js/color.js"></script>
	<script type="text/javascript" src="js/palette.js"></script>
	<script>
		var canv, file, ctx;
		var img_raw, width, height;
		$(document).ready(function() {
			$('.materialboxed').materialbox();
			$('.modal-trigger').leanModal();
		});

		function uploadFile(e) {
			Materialize.toast('UPLOADING...', 2000);
			var file = e.target.files[0];
			var filename = file.name;
			var reader = new FileReader();
			reader.onload = putImage2Canvas;
			reader.readAsDataURL(file);
		}

		function putImage2Canvas(event) {
			var img = new Image();
			img.src = event.target.result;
			img.onload = function() {
				var canv = $('#source_image')[0];
				width = canv.width = img.width;
				height = canv.height = img.height;
				ctx = canv.getContext('2d');
				ctx.drawImage(img, 0, 0);
				img_raw = ctx.getImageData(0, 0, img.width, img.height);

				Palette.init(img_raw);
				Palette.palette(img_raw.data);
				var colors=Palette.kmeansFirst();
				addPalette(colors);
				$('.source_image_area').show();
			}
		}

		function addPalette(colors){
			var tmp='';
			for (var i=1;i<colors.length;i++){
				tmp+='\
				<div class="col s1_5'+(i==1?' offset-s2 offset-m2 offset-l2':' ')+' center-align">\
					<a class="plt'+i+' z-depth-1 btn-thin btn waves-effect waves-light hide-on-med-and-up"></a>\
					<a class="plt'+i+' z-depth-1 btn-floating btn waves-effect waves-light hide-on-small-only hide-on-large-only"></a>\
					<a class="plt'+i+' z-depth-1 btn-floating btn-large waves-effect waves-light hide-on-med-and-down"></a>\
				</div>';
			}
			$('#palette').html(tmp);
			for (var i=1;i<colors.length;i++){
				var c=colors[i];
				var color='rgb('+c[0]+','+c[1]+','+c[2]+')';
				setTimeout((function(j,cl){
					return function(){
						$('.plt'+j).attr('style','background-color:'+cl+'!important');
					};
				})(i,color),500*(1+i));
			}
			setTimeout(function(){
				$('#palette').append('<div id="helper" class="col s12 center-align" style="display:none;"><h5>Click the palette to edit.</h5></div>');
				$('#helper').fadeIn(1000);
			},3500);
		}

		$('#file_path')[0].onchange = uploadFile;
	</script>
</body>

</html>
